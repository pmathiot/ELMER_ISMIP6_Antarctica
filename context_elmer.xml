<?xml version="1.0"?>
<!-- Context elmerice -->
   <context id="elmerice">

	   <calendar type="NoLeap" time_origin="<ORIGINE>-01-01 00:00:00" />

<!-- ============== Variable definition ======================== -->
    <variable_definition>
       <variable id="nsec_per_year"  type="float"  > <SEC_YEAR>  </variable>
       <variable id="nsec_per_day"   type="float"  > <SEC_DAY>   </variable>
       <variable id="rhoi"           type="float"  > <RHOI>      </variable>
    </variable_definition>

<!-- ============== FIELD DEFINITION =========================== -->
    <field_definition enabled=".TRUE.">

      <!-- ismip6 variables  -->
      <field_group id="ismip6" >
	      <field_group id="ismip6_2D_state"  operation="instant">
		      <field id="ismip6_xvelmean"   name="xvelmean"   standard_name="land_ice_vertical_mean_x_velocity" long_name="Mean velocity in x"               field_ref="ssavelocity 1_elem" unit="m s-1" > this*sftgif/$nsec_per_day </field> 
		      <field id="ismip6_yvelmean"   name="yvelmean"   standard_name="land_ice_vertical_mean_y_velocity" long_name="Mean velocity in y"               field_ref="ssavelocity 2_elem" unit="m s-1" > this*sftgif/$nsec_per_day </field>
		      <field id="ismip6_velmean"    name="velmean"                                                      long_name="Mean velocity"                    field_ref="ssavelocity_elem"   unit="m s-1" > this*sftgif/$nsec_per_day </field>
		      <field id="ismip6_lithk"      name="lithk"      standard_name="land_ice_thickness"                long_name="Ice thickness"                    field_ref="h_elem"             unit="m"     > this*sftgif               </field>
		      <field id="ismip6_lithkaf"    name="lithkaf"                                                      long_name="Ice thickness above flotation"    field_ref="haf_elem"           unit="m"     > this*sftgif               </field>
		      <field id="ismip6_orog"       name="orog"       standard_name="surface_altitude"                  long_name="Surface elevation"                field_ref="zs_elem"            unit="m"     > this*sftgif               </field>
		      <field id="ismip6_base"       name="base"       standard_name="base_altitude"                     long_name="Base elevation"                   field_ref="zb_elem"            unit="m"     > this*sftgif               </field>
		      <field id="ismip6_strbasemag" name="strbasemag" standard_name="land_ice_basal_drag"               long_name="Basal drag"                       field_ref="strbasemag"         unit="Pa"    > this*sftgif*1.0e6         </field>
		      <field id="ismip6_topg"       name="topg"       standard_name="bedrock_altitude"                  long_name="Bedrock elevation"                field_ref="bedrock_elem"       unit="m"    />
		      <field id="ismip6_sftgif"     name="sftgif"     standard_name="land_ice_area_fraction"            long_name="Land ice area fraction"           field_ref="sftgif"             unit="1"    />
	              <field id="ismip6_sftgrf"     name="sftgrf"     standard_name="grounded_ice_sheet_area_fraction"  long_name="Grounded ice sheet area fraction" field_ref="sftgrf"             unit="1"    />                     
                      <field id="ismip6_sftflf"     name="sftflf"     standard_name="floating_ice_shelf_area_fraction"  long_name="Floating ice sheet area fraction" field_ref="sftflf"             unit="1"    /> 
	      </field_group>

              <field_group id="ismip6_2D_flux" grid_ref="GridCells" operation="average">
	              <field id="ismip6_acabf"       name="acabf"       standard_name="land_ice_surface_specific_mass_balance_flux"                      long_name="Surface Mass Balance flux"                    field_ref="acabf"              unit="kg m-2 s-1" > this*sftgif*$rhoi/$nsec_per_day  </field>
                      <field id="ismip6_acabfgr"     name="acabfgr"                                                                                      long_name="Surface Mass Balance flux on grounded ice"    field_ref="acabf"              unit="kg m-2 s-1" > this*sftgrf*$rhoi/$nsec_per_day  </field>
                      <field id="ismip6_acabffl"     name="acabffl"                                                                                      long_name="Surface Mass Balance flux on floating ice"    field_ref="acabf"              unit="kg m-2 s-1" > this*sftflf*$rhoi/$nsec_per_day  </field>
                      <field id="ismip6_libmassbf"   name="libmassbf"                                                                                    long_name="Basal Mass Balance flux"                      field_ref="libmassbf"          unit="kg m-2 s-1" > this*sftgif*$rhoi/$nsec_per_day  </field>
                      <field id="ismip6_libmassbfgr" name="libmassbfgr" standard_name="land_ice_basal_specific_mass_balance_flux"                        long_name="Basal Mass Balance flux beneath grounded ice" field_ref="libmassbf"          unit="kg m-2 s-1" > this*sftgrf*$rhoi/$nsec_per_day  </field>
	              <field id="ismip6_libmassbffl" name="libmassbffl" standard_name="land_ice_basal_specific_mass_balance_flux"                        long_name="Basal Mass Balance flux beneath floating ice" field_ref="libmassbf"          unit="kg m-2 s-1" > this*sftflf*$rhoi/$nsec_per_day  </field>
		      <field id="ismip6_dlithkdt"    name="dlithkdt"    standard_name="tendency_of_land_ice_thickness"                                   long_name="Ice thickness imbalance"                      field_ref="h velocity_elem"    unit="m s-1"      > this*sftgif/$nsec_per_day        </field>
		      <field id="ismip6_ligroundf"   name="ligroundf"   standard_name="land_ice_specific_mass_flux_at_grounding_line"                    long_name="Grounding line flux"                          field_ref="ligroundf"          unit="kg m-2 s-1" > -this*sftgif*$rhoi/$nsec_per_day </field>
                      <field id="ismip6_lifmassbf"   name="lifmassbf"   standard_name="land_ice_specific_mass_flux_due_to_calving_and_ice_front_melting" long_name="Ice front melt and calving flux"              field_ref="calving_front_flux" unit="kg m-2 s-1" > -this*sftgif*$rhoi/$nsec_per_day </field>
              </field_group>

	      <field_group id="ismip6_1D" grid_ref="ScalarGrid_sum">
		      <field id="ismip6_lim"             name="lim"             standard_name="land_ice_mass"                                                  long_name="Total ice mass"                           field_ref="h_elem"             unit="kg"     > this*sftgif*cell_area*$rhoi </field>
		      <field id="ismip6_limnsw"          name="limnsw"          standard_name="land_ice_mass_not_displacing_sea_water"                         long_name="Mass above floatation"                    field_ref="haf_elem"           unit="kg"     > this*sftgif*cell_area*$rhoi </field>
                      <field id="ismip6_iarea"           name="iarea"                                                                                          long_name="Ice area"                                 field_ref="sftgif"             unit="m2"     > this*cell_area              </field>
                      <field id="ismip6_iareagr"         name="iareagr"         standard_name="grounded_ice_sheet_area"                                        long_name="Grounded ice area"                        field_ref="sftgrf"             unit="m2"     > this*cell_area              </field>
                      <field id="ismip6_iareafl"         name="iareafl"         standard_name="floating_ice_shelf_area"                                        long_name="Floating ice area"                        field_ref="sftflf"             unit="m2"     > this*cell_area              </field>
		      <field id="ismip6_tendacabf"       name="tendacabf"       standard_name="tendency_of_land_ice_mass_due_to_surface_mass_balance"          long_name="Total SMB flux"                           field_ref="ismip6_acabf"       unit="kg s-1" > this*cell_area              </field>
                      <field id="ismip6_tendacabfgr"     name="tendacabfgr"                                                                                    long_name="Total SMB flux on grounded ice"           field_ref="ismip6_acabfgr"     unit="kg s-1" > this*cell_area              </field>
                      <field id="ismip6_tendacabffl"     name="tendacabffl"                                                                                    long_name="Total SMB flux on floating ice"           field_ref="ismip6_acabffl"     unit="kg s-1" > this*cell_area              </field>
                      <field id="ismip6_tendlibmassbf"   name="tendlibmassbf"   standard_name="tendency_of_land_ice_mass_due_to_basal_mass_balance"            long_name="Total BMB flux"                           field_ref="ismip6_libmassbf"   unit="kg s-1" > this*cell_area              </field>
		      <field id="ismip6_tendlibmassbfgr" name="tendlibmassbfgr"                                                                                long_name="Total BMB flux beneath grounded ice"      field_ref="ismip6_libmassbfgr" unit="kg s-1" > this*cell_area              </field>
		      <field id="ismip6_tendlibmassbffl" name="tendlibmassbffl" standard_name="tendency_of_land_ice_mass_due_to_basal_mass_balance"            long_name="Total BMB flux beneath floating ice"      field_ref="ismip6_libmassbffl" unit="kg s-1" > this*cell_area              </field>
                      <field id="ismip6_tendligroundf"   name="tendligroundf"   standard_name="tendency_of_grounded_ice_mass"                                  long_name="Total grounding line flux"                field_ref="ismip6_ligroundf"   unit="kg s-1" > this*cell_area              </field>
		      <field id="ismip6_tendlifmassbf"   name="tendlifmassbf"   standard_name="tendency_of_land_ice_mass_due_to_calving_and_ice_front_melting" long_name="Total calving and ice front melting flux" field_ref="ismip6_lifmassbf"   unit="kg s-1" > this*cell_area              </field>
	      </field_group>

	      <field_group id="ismip6_1D_true_cell_area" grid_ref="ScalarGrid_sum">
                      <field id="ismip6_lim_tca"             name="lim_tca"             standard_name="land_ice_mass"                                                  long_name="Total ice mass"                           field_ref="h_elem"             unit="kg"     > this*sftgif*true_cell_area*$rhoi </field>
                      <field id="ismip6_limnsw_tca"          name="limnsw_tca"          standard_name="land_ice_mass_not_displacing_sea_water"                         long_name="Mass above floatation"                    field_ref="haf_elem"           unit="kg"     > this*sftgif*true_cell_area*$rhoi </field>
                      <field id="ismip6_iarea_tca"           name="iarea_tca"                                                                                          long_name="Ice area"                                 field_ref="sftgif"             unit="m2"     > this*true_cell_area              </field>
                      <field id="ismip6_iareagr_tca"         name="iareagr_tca"         standard_name="grounded_ice_sheet_area"                                        long_name="Grounded ice area"                        field_ref="sftgrf"             unit="m2"     > this*true_cell_area              </field>
                      <field id="ismip6_iareafl_tca"         name="iareafl_tca"         standard_name="floating_ice_shelf_area"                                        long_name="Floating ice area"                        field_ref="sftflf"             unit="m2"     > this*true_cell_area              </field>
                      <field id="ismip6_tendacabf_tca"       name="tendacabf_tca"       standard_name="tendency_of_land_ice_mass_due_to_surface_mass_balance"          long_name="Total SMB flux"                           field_ref="ismip6_acabf"       unit="kg s-1" > this*true_cell_area              </field>
                      <field id="ismip6_tendacabfgr_tca"     name="tendacabfgr_tca"                                                                                    long_name="Total SMB flux on grounded ice"           field_ref="ismip6_acabfgr"     unit="kg s-1" > this*true_cell_area              </field>
                      <field id="ismip6_tendacabffl_tca"     name="tendacabffl_tca"                                                                                    long_name="Total SMB flux on floating ice"           field_ref="ismip6_acabffl"     unit="kg s-1" > this*true_cell_area              </field>
                      <field id="ismip6_tendlibmassbf_tca"   name="tendlibmassbf_tca"   standard_name="tendency_of_land_ice_mass_due_to_basal_mass_balance"            long_name="Total BMB flux"                           field_ref="ismip6_libmassbf"   unit="kg s-1" > this*true_cell_area              </field>
                      <field id="ismip6_tendlibmassbfgr_tca" name="tendlibmassbfgr_tca"                                                                                long_name="Total BMB flux beneath grounded ice"      field_ref="ismip6_libmassbfgr" unit="kg s-1" > this*true_cell_area              </field>
                      <field id="ismip6_tendlibmassbffl_tca" name="tendlibmassbffl_tca" standard_name="tendency_of_land_ice_mass_due_to_basal_mass_balance"            long_name="Total BMB flux beneath floating ice"      field_ref="ismip6_libmassbffl" unit="kg s-1" > this*true_cell_area              </field>
                      <field id="ismip6_tendligroundf_tca"   name="tendligroundf_tca"   standard_name="tendency_of_grounded_ice_mass"                                  long_name="Total grounding line flux"                field_ref="ismip6_ligroundf"   unit="kg s-1" > this*true_cell_area              </field>
                      <field id="ismip6_tendlifmassbf_tca"   name="tendlifmassbf_tca"   standard_name="tendency_of_land_ice_mass_due_to_calving_and_ice_front_melting" long_name="Total calving and ice front melting flux" field_ref="ismip6_lifmassbf"   unit="kg s-1" > this*true_cell_area              </field>
              </field_group>


      <!-- end: ismip6 variables  -->
      </field_group>
      <field_group id="elmer" operation="instant" >
	      <field_group id="elmer_topo" >
		      <field id="h"               long_name="Ice thickness (node)"                 unit="m"     grid_ref="GridNodes" />
		      <field id="h_elem"          long_name="Ice thickness (cell)"                 unit="m"     grid_ref="GridCells" />
		      <field id="h velocity"      long_name="Ice thickness imbalance (node)"       unit="m d-1" grid_ref="GridNodes" />
		      <field id="h velocity_elem" long_name="Ice thickness imbalance (cell)"       unit="m d-1" grid_ref="GridCells" />
		      <field id="zs"              long_name="Surface elevation (node)"             unit="m"     grid_ref="GridNodes" comment="ref : wrt geoid EIGEN-6C4 (positive up)" />
		      <field id="zs_elem"         long_name="Surface elevation (cell)"             unit="m"     grid_ref="GridCells" comment="ref : wrt geoid EIGEN-6C4 (positive up)" />
		      <field id="zb"              long_name="base elevation (node)"                unit="m"     grid_ref="GridNodes" comment="ref : wrt geoid EIGEN-6C4 (positive up)" />
		      <field id="zb_elem"         long_name="base elevation (cell)"                unit="m"     grid_ref="GridCells" comment="ref : wrt geoid EIGEN-6C4 (positive up)" />
		      <field id="haf"             long_name="Ice thickness above flotation (node)" unit="m"     grid_ref="GridNodes" />
		      <field id="haf_elem"        long_name="Ice thickness above flotation (cell)" unit="m"     grid_ref="GridCells" />
		      <field id="bedrock"         long_name="Bedrock elevation (node)"             unit="m"     grid_ref="GridNodes" comment="ref : wrt geoid EIGEN-6C4 (positive up)" />
		      <field id="bedrock_elem"    long_name="Bedrock elevation (cell)"             unit="m"     grid_ref="GridCells" comment="ref : wrt geoid EIGEN-6C4 (positive up)" />
		      <field id="salinity"        long_name="ocean salinity"                       unit="g/kg"  grid_ref="GridNodes" />
		      <field id="temperature"     long_name="ocean temperature"                    unit="°C"    grid_ref="GridNodes" />
	      </field_group>

	      <field_group id="elmer_masks" >
		      <field id="groundedmask"                                                           unit="1" grid_ref="GridNodes" />
		      <field id="sftgif"          long_name="Land ice area fraction"                     unit="1" grid_ref="GridCells" />
                      <field id="sftgrf"          long_name="Grounded ice sheet area fraction"           unit="1" grid_ref="GridCells" />
		      <field id="sftflf"          long_name="Floating ice sheet area fraction"           unit="1" grid_ref="GridCells" />
                      <field id="basins"          long_name="Mask of sub-ice catchments from Reese"      unit="1" grid_ref="GridCells" />
	              <field id="imbie_iceshelf"  long_name="Mask of iceshelf ice catchments from IMBIE" unit="1" grid_ref="GridCells" />
	              <field id="imbie_basins"    long_name="Mask of large ice catchments from IMBIE"    unit="1" grid_ref="GridCells" />
                      <field id="imbie_subbasins" long_name="Mask of sub-ice catchments from IMBIE"      unit="1" grid_ref="GridCells" />
	      </field_group>

               <field_group id="elmer_velocity" >
		      <field id="ssavelocity 1"                                     long_name="Mean velocity in x (node)"        unit="m d-1" grid_ref="GridNodes" />
		      <field id="ssavelocity 2"                                     long_name="Mean velocity in y (node)"        unit="m d-1" grid_ref="GridNodes" />
		      <field id="ssavelocity 1_elem"                                long_name="Mean velocity in x (cell)"        unit="m d-1" grid_ref="GridCells" />
		      <field id="ssavelocity 2_elem"                                long_name="Mean velocity in y (cell)"        unit="m d-1" grid_ref="GridCells" />
		      <field id="ligroundf"                                         long_name="Grounding line flux"              unit="m d-1" grid_ref="GridCells" />
                      <field id="calving_front_flux"                                long_name="Ice front melt and calving flux"  unit="m d-1" grid_ref="GridCells" />
		      <field id="vx"                 field_ref="ssavelocity 1"      long_name="Mean velocity in x (node)"        unit="m d-1" grid_ref="GridNodes" />
		      <field id="vy"                 field_ref="ssavelocity 2"      long_name="Mean velocity in y (node)"        unit="m d-1" grid_ref="GridNodes" />
		      <field id="vnorm"                                             long_name="Mean velocity (node)"             unit="m d-1" grid_ref="GridNodes" > sqrt(vx^2+vy^2)           </field>
		      <field id="vx_elem"            field_ref="ssavelocity 1_elem" long_name="Mean velocity in x (cell)"        unit="m d-1" grid_ref="GridCells" />
		      <field id="vy_elem"            field_ref="ssavelocity 2_elem" long_name="Mean velocity in y (cell)"        unit="m d-1" grid_ref="GridCells" />
		      <field id="ssavelocity_elem"                                  long_name="Mean velocity (cell)"             unit="m d-1" grid_ref="GridCells" > sqrt(vx_elem^2+vy_elem^2) </field>
	      </field_group>


	      <field_group id="elmer_friction" >
		      <field id="strbasemag" long_name="Basal drag"                                       unit="MPa"       grid_ref="GridCells" />
		      <field id="ceff"       long_name="Effective friction coefficent (Weertmann linear)" unit="MPa m-1 d" grid_ref="GridNodes" />
	      </field_group>

              <field_group id="elmer_restart" >
                      <FRICTION_FIELD>
                      <field id="eta"      long_name="Viscosity correction coefficient"         unit="1"         grid_ref="GridNodes" />
                      <field id="mueta2"   long_name="Corrected viscosity"                      unit="MPa d1/3"  grid_ref="GridNodes" />
	      </field_group>

	      <field_group id="elmer_flowlaw" >
		      <field id="mu" long_name="Viscosity" unit="MPa d1/3" grid_ref="GridNodes" operation="once" />
	      </field_group>

	      <field_group id="elmer_forcings" >
                      <field id="melt"      long_name="Basal Mass Balance"               unit="m d-1"  grid_ref="GridCells" />
                      <field id="smb"       long_name="Surface Mass Balance (reference)" unit="m d-1"  grid_ref="GridCells" />
		      <field id="asmb"      long_name="Surface Mass Balance (anomaly)"   unit="m d-1"  grid_ref="GridCells" />
		      <field id="acabf"     long_name="Surface Mass Balance (total)"     unit="m d-1"  grid_ref="GridCells" />
		      <field id="tf"        long_name="Thermal Forcing"                  unit="K"      grid_ref="GridCells" />
		      <field id="libmassbf" long_name="Basal Mass Balance"               unit="m d-1"  grid_ref="GridCells" />
		      <field id="h loads"                                                unit="m3 d-1" grid_ref="GridNodes" />
	      </field_group>

              <field_group id="mesh_info2" operation= "instant" >
                      <field id="node_x"         name="x"              long_name="projected x coordinate"                     unit="m"  grid_ref="GridNodes" />
                      <field id="node_y"         name="y"              long_name="projected y coordinate"                     unit="m"  grid_ref="GridNodes" />
                      <field id="cell_area"      name="cell_area"      long_name="cell area"                                  unit="m2" grid_ref="GridCells" />
                      <field id="true_cell_area" name="true_cell_area" long_name="true value of cell area (projected)"        unit="m2" grid_ref="GridCells" />
	              <field id="basins"                               long_name="Mask of sub-ice catchments from Reese"      unit="1"  grid_ref="GridCells" />
                      <field id="imbie_iceshelf"                       long_name="Mask of iceshelf ice catchments from IMBIE" unit="1"  grid_ref="GridCells" />
                      <field id="imbie_basins"                         long_name="Mask of large ice catchments from IMBIE"    unit="1"  grid_ref="GridCells" />
                      <field id="imbie_subbasins"                      long_name="Mask of sub-ice catchments from IMBIE"      unit="1"  grid_ref="GridCells" />
	      </field_group>

              <field_group id="elmer_global" grid_ref="ScalarGrid_sum">
                      <field id="time" name="elmer_time" long_name="time" unit="d" prec="8" />
              </field_group>
      </field_group>

    </field_definition>

<!-- ============== FILE DEFINITION ============================= -->
    <file_definition src="./file_def_elmer.xml"/>

<!-- ============== DOMAIN DEFINITION =========================== -->
    <domain_definition> 
      <!-- mandatory domains ...  -->
      <domain id="cells" name="mesh2D"/>
      <domain id="edges" name="mesh2D"/>
      <domain id="nodes" name="mesh2D"/>
      <!-- ...  -->
    </domain_definition>

<!-- ============== GRID DEFINITION ============================= -->
    <grid_definition>
     
      <!-- mandatory grids... -->
      <grid id="GridCells">
        <domain domain_ref="cells"/>
      </grid>

      <grid id="GridNodes">
        <domain domain_ref="nodes"/>
      </grid>

      <grid id="GridEdges">
        <domain domain_ref="edges"/>
      </grid>
      <!-- ...  -->

      <grid id="ScalarGrid_sum">
        <scalar id="scalar_sum" >
              <reduce_domain operation="sum" />
        </scalar>
      </grid>

      <grid id="ScalarGrid_min">
        <scalar id="scalar_min" >
              <reduce_domain operation="min" />
        </scalar>
      </grid>

      <grid id="ScalarGrid_max">
        <scalar id="scalar_max" >
              <reduce_domain operation="max" />
        </scalar>
       </grid>

    </grid_definition>

  </context>
